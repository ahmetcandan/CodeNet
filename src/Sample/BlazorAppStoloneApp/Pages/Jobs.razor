@page "/jobs"
@using CodeNetUI_Example.Models
@using CodeNetUI_Example.Services
@using Microsoft.AspNetCore.SignalR.Client

@inject HubConnection HubConnection
@inject IDialogService DialogService
@inject BackgroundService BackgroundService
@inject LoginService LoginService

<PageTitle>Jobs</PageTitle>

<MudTable Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading" LoadingProgressColor="Color.Info" ServerData="ServerReload">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Schecule Jobs</MudText>
    </ToolBarContent>
    <HeaderContent>
        <MudTh></MudTh>
        <MudTh>Job Id</MudTh>
        <MudTh>Service</MudTh>
        <MudTh>Cron Expression</MudTh>
        <MudTh>Period Time</MudTh>
        <MudTh>Expry Time</MudTh>
        <MudTh>Status</MudTh>
        <MudTh></MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="">
            <MudIconButton OnClick="async () => await JobDetails(context.Id)" Icon="material-symbols-outlined/Checklist" aria-label="Checklist" />
        </MudTd>
        <MudTd DataLabel="Job Id">@context.Id</MudTd>
        <MudTd DataLabel="Service">@context.Title</MudTd>
        <MudTd DataLabel="Cron Expression">@context.CronExpression</MudTd>
        <MudTd DataLabel="Period Time">@context.PeriodTime</MudTd>
        <MudTd DataLabel="Expry Time">@context.ExpryTime</MudTd>
        <MudTd DataLabel="Status">
            <MudProgressLinear Color="Color.Primary" Indeterminate="context.Status == JobStatus.Running" Class="my-7" />
        </MudTd>
        <MudTd>
            <MudIconButton Disabled="context.Status == JobStatus.Running" OnClick="async () => await ExecuteJob(context.Id)" Icon="material-symbols-outlined/refresh" aria-label="refresh" />
        </MudTd>
    </RowTemplate>
    <NoRecordsContent>
        <MudText>No matching records found</MudText>
    </NoRecordsContent>
    <LoadingContent>
        <MudText>Loading...</MudText>
    </LoadingContent>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>

<MudButton OnClick="OpenLogin">Login</MudButton>
<MudButton OnClick="Logout">Logout</MudButton>

@code {
    PagingResponse<JobModel>? model;
    private bool _loading = false;
    private bool _runJobVisible = false;

    protected override async Task OnInitializedAsync()
    {
        HubConnection.On<JobStatusChangeArgs>("ChangeStatus_ScheculeJob", ReceivedMessage);
        if (HubConnection.State != HubConnectionState.Connected)
            await HubConnection.StartAsync();
    }

    private async Task<TableData<JobModel>> ServerReload(TableState state, CancellationToken cancellationToken)
    {
        _loading = true;
        model = await BackgroundService.GetJobs(state.Page + 1, state.PageSize, cancellationToken);
        _loading = false;
        if (model?.List is not null)
            foreach (var row in model.List)
                row.PropertyChanged += (sender, e) => InvokeAsync(StateHasChanged);

        return new TableData<JobModel>() { TotalItems = model?.TotalCount ?? 0, Items = model?.List ?? [] };
    }

    void ReceivedMessage(JobStatusChangeArgs args)
    {
        var item = model?.List.FirstOrDefault(c => c.Id == args.JobId);
        if (item is not null)
            item.Status = args.Status;
    }

    async Task ExecuteJob(int jobId)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Job Execute",
            "Should the task be run?",
            yesText: "Yes!", cancelText: "Cancel");
        if (result == true)
            await BackgroundService.ExecuteJob(jobId);
    }

    async Task OpenLogin()
    {
        await DialogService.ShowAsync<Login>("Login", new DialogOptions
            {
                FullWidth = true,
                MaxWidth = MaxWidth.Small,
                BackdropClick = false
            });
    }

    async Task Logout()
    {
        await LoginService.Logout();
    }

    async Task JobDetails(int jobId)
    {
        await DialogService.ShowAsync<JobDetails>("Job Details", new DialogParameters<JobDetails>
            {
                { x => x.JobId, jobId }
            }, new DialogOptions
            {
                FullWidth = true,
                MaxWidth = MaxWidth.ExtraLarge
            });
    }
}
